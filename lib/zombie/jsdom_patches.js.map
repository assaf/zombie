{"version":3,"sources":["zombie/jsdom_patches.js"],"names":[],"mappings":"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","file":"zombie/jsdom_patches.js","sourcesContent":["// Fix things that JSDOM doesn't do quite right.\n\n\nconst DOM  = require('./dom');\n\n\nDOM.HTMLDocument.prototype.__defineGetter__('scripts', function() {\n  return new DOM.HTMLCollection(this, ()=> this.querySelectorAll('script'));\n});\n\n\n// Default behavior for clicking on links: navigate to new URL if specified.\nDOM.HTMLAnchorElement.prototype._eventDefaults = {};\nDOM.HTMLAnchorElement.prototype._eventDefaults.click = function(event) {\n  const anchor = event.target;\n  if (!anchor.href)\n    return;\n\n  const { window }  = anchor.ownerDocument;\n  const { browser } = window;\n  // Decide which window to open this link in\n  switch (anchor.target || '_self') {\n    case '_self': {   // navigate same window\n      window.location = anchor.href;\n      break;\n    }\n    case '_parent': { // navigate parent window\n      window.parent.location = anchor.href;\n      break;\n    }\n    case '_top': {    // navigate top window\n      window.top.location = anchor.href;\n      break;\n    }\n    default: { // open named window\n      browser.tabs.open({ name: anchor.target, url: anchor.href });\n      break;\n    }\n  }\n  browser.emit('link', anchor.href, anchor.target || '_self');\n};\n\n\n// Attempt to load the image, this will trigger a 'load' event when succesful\n// jsdom seemed to only queue the 'load' event\nDOM.HTMLImageElement.prototype._attrModified = function(name, value, oldVal) {\n  if (name === 'src') {\n    const src = DOM.resourceLoader.resolve(this._ownerDocument, value);\n    if (this.src !== src)\n      DOM.resourceLoader.load(this, value);\n  }\n};\n\n\n// Implement insertAdjacentHTML\nDOM.HTMLElement.prototype.insertAdjacentHTML = function(position, html) {\n  const { parentNode }  = this;\n  const container       = this.ownerDocument.createElementNS('http://www.w3.org/1999/xhtml', '_');\n  container.innerHTML   = html;\n\n  switch (position.toLowerCase()) {\n    case 'beforebegin': {\n      while (container.firstChild)\n        parentNode.insertBefore(container.firstChild, this);\n      break;\n    }\n    case 'afterbegin': {\n      let firstChild = this.firstChild;\n      while (container.lastChild)\n        firstChild = this.insertBefore(container.lastChild, firstChild);\n      break;\n    }\n    case 'beforeend': {\n      while (container.firstChild)\n        this.appendChild(container.firstChild);\n      break;\n    }\n    case 'afterend': {\n      let nextSibling = this.nextSibling;\n      while (container.lastChild)\n        nextSibling = parentNode.insertBefore(container.lastChild, nextSibling);\n      break;\n    }\n  }\n};\n\n\n// Implement documentElement.contains\n// e.g., if(document.body.contains(el)) { ... }\n// See https://developer.mozilla.org/en-US/docs/DOM/Node.contains\nDOM.Node.prototype.contains = function(otherNode) {\n  // DDOPSON-2012-08-16 -- This implementation is stolen from Sizzle's\n  // implementation of 'contains' (around line 1402).\n  // We actually can't call Sizzle.contains directly:\n  // * Because we define Node.contains, Sizzle will configure it's own\n  //   \"contains\" method to call us. (it thinks we are a native browser\n  //   implementation of \"contains\")\n  // * Thus, if we called Sizzle.contains, it would form an infinite loop.\n  //   Instead we use Sizzle's fallback implementation of \"contains\" based on\n  //   \"compareDocumentPosition\".\n  return !!(this.compareDocumentPosition(otherNode) & 16);\n};\n\n\n// Support for opacity style property.\nObject.defineProperty(DOM.CSSStyleDeclaration.prototype, 'opacity', {\n  get() {\n    const opacity = this.getPropertyValue('opacity');\n    return Number.isFinite(opacity) ? opacity.toString() : '';\n  },\n\n  set(opacity) {\n    if (opacity === null || opacity === undefined || opacity === '') {\n      this.removeProperty('opacity');\n    } else {\n      const value = parseFloat(opacity);\n      if (isFinite(value))\n        this._setProperty('opacity', value);\n    }\n  }\n});\n\n\n// Wrap dispatchEvent to support _windowInScope and error handling.\nconst jsdomDispatchEvent = DOM.EventTarget.prototype.dispatchEvent;\nDOM.EventTarget.prototype.dispatchEvent = function(event) {\n  // Could be node, window or document\n  const document    = this._ownerDocument || this.document || this;\n  const window      = document.parentWindow;\n  // Fail miserably on objects that don't have ownerDocument: nodes and XHR\n  // request have those\n  const { browser } = window;\n  browser.emit('event', event, this);\n\n  const originalInScope = browser._windowInScope;\n  try {\n    // The current window, postMessage and window.close need this\n    browser._windowInScope = window;\n    // Inline event handlers rely on window.event\n    window.event = event;\n    return jsdomDispatchEvent.call(this, event);\n  } finally {\n    delete window.event;\n    browser._windowInScope = originalInScope;\n  }\n};\n\n\n// Wrap raise to catch and propagate all errors to window\nconst jsdomRaise = DOM.Document.prototype.raise;\nDOM.Document.prototype.raise = function(type, message, data) {\n  jsdomRaise.call(this, type, message, data);\n\n  const error = data && (data.exception || data.error);\n  if (!error)\n    return;\n\n  const document  = this;\n  const window    = document.parentWindow;\n  // Deconstruct the stack trace and strip the Zombie part of it\n  // (anything leading to this file).  Add the document location at\n  // the end.\n  const partial = [];\n  // \"RangeError: Maximum call stack size exceeded\" doesn't have a stack trace\n  if (error.stack) {\n    for (let line of error.stack.split('\\n')) {\n      if (~line.indexOf('contextify/lib/contextify.js'))\n        break;\n      partial.push(line);\n    }\n  }\n  partial.push(`    in ${document.location.href}`);\n  error.stack = partial.join('\\n');\n\n  window._eventQueue.onerror(error);\n};\n\n"],"sourceRoot":"/source/"}